# ç«‹å³æ‰§è¡Œæ­¥éª¤ - è§£å†³å¤šä¸ª Bot å®ä¾‹å†²çª

## ğŸ“‹ æ ¹æ®æ—¥å¿—åˆ†æï¼Œå‘ç°çš„é—®é¢˜ï¼š

1. **æœ‰å¤šä¸ª Bot å®ä¾‹åœ¨è¿è¡Œ**ï¼ˆTelegramConflictErrorï¼‰
2. **è¿›ç¨‹ PID 1059** åœ¨ 02:23 å¯åŠ¨ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨å¯åŠ¨æˆ–é€šè¿‡å…¶ä»–æ–¹å¼
3. **æœåŠ¡å™¨ä»£ç æœªæ›´æ–°**ï¼ˆä»æœ‰ TypeErrorï¼‰

## ğŸš€ ç«‹å³æ‰§è¡Œçš„æ­¥éª¤

### æ­¥éª¤ 1ï¼šåœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œå…¨é¢æ£€æŸ¥

```bash
cd /home/ubuntu/wushizhifu/bot

# ä¸Šä¼ å¹¶è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼ˆæˆ–å¤åˆ¶è„šæœ¬å†…å®¹ï¼‰
chmod +x å…¨é¢æ£€æŸ¥æ‰€æœ‰å¯åŠ¨é¡¹.sh
./å…¨é¢æ£€æŸ¥æ‰€æœ‰å¯åŠ¨é¡¹.sh
```

### æ­¥éª¤ 2ï¼šå¼ºåˆ¶åœæ­¢æ‰€æœ‰å®ä¾‹

```bash
cd /home/ubuntu/wushizhifu/bot

# æ–¹æ³• 1ï¼šä½¿ç”¨è„šæœ¬
chmod +x å¼ºåˆ¶åœæ­¢æ‰€æœ‰å®ä¾‹.sh
./å¼ºåˆ¶åœæ­¢æ‰€æœ‰å®ä¾‹.sh

# æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ‰§è¡Œ
sudo systemctl stop wushizhifu-bot
sudo pkill -9 -f bot.py
sudo pkill -9 -f "python.*wushizhifu.*bot"

# ç‰¹åˆ«æ³¨æ„ï¼šå¦‚æœæœ‰ PID 1059 æˆ–å…¶ä»–ç‰¹å®šè¿›ç¨‹
sudo kill -9 1059  # æ›¿æ¢ä¸ºå®é™… PID

# æ£€æŸ¥ screen/tmux
screen -ls | grep bot | awk '{print $1}' | xargs -I {} screen -S {} -X quit 2>/dev/null
tmux ls | grep bot | cut -d: -f1 | xargs -I {} tmux kill-session -t {} 2>/dev/null

# æœ€ç»ˆç¡®è®¤
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥æ²¡æœ‰ä»»ä½•è¾“å‡º
```

### æ­¥éª¤ 3ï¼šæ›´æ–°ä»£ç 

```bash
cd /home/ubuntu/wushizhifu/bot

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# ç¡®è®¤ä»£ç å·²æ›´æ–°
grep "def get_main_keyboard(user_id" keyboards/main_kb.py
# åº”è¯¥çœ‹åˆ°ï¼šdef get_main_keyboard(user_id: int = None, is_admin: bool = False)

# æ¸…é™¤ç¼“å­˜
find . -name "*.pyc" -delete
find . -name "__pycache__" -type d -exec rm -r {} + 2>/dev/null || true
```

### æ­¥éª¤ 4ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯åŠ¨æ–¹å¼

```bash
# æ£€æŸ¥ cron
crontab -l | grep -i bot
sudo crontab -l | grep -i bot

# æ£€æŸ¥å¯åŠ¨è„šæœ¬
find /home/ubuntu -name "*.sh" -exec grep -l "bot.py\|python.*bot" {} \;

# æ£€æŸ¥ shell å¯åŠ¨æ–‡ä»¶
grep -r "bot\|python.*wushizhifu" ~/.bashrc ~/.profile 2>/dev/null
```

### æ­¥éª¤ 5ï¼šé‡æ–°å¯åŠ¨ï¼ˆä»…é€šè¿‡ systemdï¼‰

```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start wushizhifu-bot

# ç­‰å¾… 5 ç§’
sleep 5

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status wushizhifu-bot --no-pager -l | head -20

# ç¡®è®¤åªæœ‰ä¸€ä¸ªè¿›ç¨‹
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥åªæœ‰ 1 ä¸ªè¿›ç¨‹
```

### æ­¥éª¤ 6ï¼šéªŒè¯ä¿®å¤

```bash
# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u wushizhifu-bot -n 50 --no-pager

# æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
sudo journalctl -u wushizhifu-bot -n 100 --no-pager | grep -i "conflict\|typeerror\|error"
# åº”è¯¥æ²¡æœ‰ç›¸å…³é”™è¯¯

# åœ¨ Telegram ä¸­æµ‹è¯•
# å‘é€ /start å‘½ä»¤ï¼Œåº”è¯¥æ­£å¸¸å“åº”
```

## ğŸ”‘ å…³é”®è¦ç‚¹

1. **ç¡®ä¿åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œ**ï¼šæ£€æŸ¥ç»“æœåº”è¯¥åªæœ‰ 1 ä¸ªè¿›ç¨‹
2. **åªé€šè¿‡ systemd å¯åŠ¨**ï¼šä¸è¦æ‰‹åŠ¨è¿è¡Œ `python bot.py`
3. **ä»£ç å¿…é¡»æ›´æ–°**ï¼šç¡®ä¿ `get_main_keyboard` å‡½æ•°ç­¾åæ­£ç¡®
4. **æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„å¯åŠ¨æ–¹å¼**ï¼šcron, screen, tmux, å¯åŠ¨è„šæœ¬ç­‰

## âš ï¸ å¦‚æœä»ç„¶æœ‰å†²çª

å¦‚æœæ‰§è¡Œåä»ç„¶æœ‰ `TelegramConflictError`ï¼š

1. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æœåŠ¡å™¨åœ¨ä½¿ç”¨åŒä¸€ä¸ª Bot Token
2. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç”¨æˆ·ï¼ˆå¦‚ rootï¼‰åœ¨è¿è¡Œ Bot
3. è€ƒè™‘é‡æ–°ç”Ÿæˆ Bot Tokenï¼ˆæœ€åæ‰‹æ®µï¼‰

