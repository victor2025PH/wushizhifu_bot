# è§£å†³ä¸€å¯åŠ¨å°±å˜æˆä¸¤ä¸ªè¿›ç¨‹çš„é—®é¢˜

## ðŸ” é—®é¢˜åˆ†æž

ä¸€å¯åŠ¨å°±å˜æˆä¸¤ä¸ªè¿›ç¨‹ï¼Œå¯èƒ½çš„åŽŸå› ï¼š

1. **æœ‰å¤šä¸ª systemd æœåŠ¡æ–‡ä»¶**ï¼ˆå¦‚ `wushipay-bot.service` å’Œ `wushizhifu-bot.service`ï¼‰
2. **`Restart=always` å¯¼è‡´å¼‚å¸¸é‡å¯**ï¼Œsystemd è‡ªåŠ¨é‡å¯å¤±è´¥çš„æœåŠ¡
3. **æœåŠ¡é…ç½®æœ‰é—®é¢˜**ï¼Œå¯¼è‡´å¯åŠ¨åŽç«‹å³å¤±è´¥å¹¶é‡å¯
4. **æœ‰å¤šä¸ªæœåŠ¡åŒæ—¶å¯åŠ¨ Bot**

## ðŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ­¥éª¤ 1ï¼šè¯Šæ–­é—®é¢˜

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /home/ubuntu/wushizhifu/bot

# ä¸Šä¼ å¹¶è¿è¡Œè¯Šæ–­è„šæœ¬
chmod +x è¯Šæ–­å¹¶é‡æ–°è®¾ç½®å¯åŠ¨é¡¹.sh
./è¯Šæ–­å¹¶é‡æ–°è®¾ç½®å¯åŠ¨é¡¹.sh
```

æˆ–è€…æ‰‹åŠ¨æ£€æŸ¥ï¼š

```bash
# 1. æ£€æŸ¥æ‰€æœ‰æœåŠ¡æ–‡ä»¶
sudo find /etc/systemd/system -name "*bot*" -o -name "*wushizhifu*"

# 2. æ£€æŸ¥æ‰€æœ‰æœåŠ¡
systemctl list-units --all --type=service | grep -iE "bot|wushizhifu"

# 3. æ£€æŸ¥è¿›ç¨‹æ ‘ï¼ˆçœ‹è¿›ç¨‹å…³ç³»ï¼‰
ps auxf | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
```

### æ­¥éª¤ 2ï¼šå½»åº•æ¸…ç†å¹¶é‡æ–°è®¾ç½®

```bash
cd /home/ubuntu/wushizhifu/bot

# ä¸Šä¼ å¹¶è¿è¡Œé‡æ–°è®¾ç½®è„šæœ¬
chmod +x é‡æ–°è®¾ç½®å¯åŠ¨é¡¹.sh
./é‡æ–°è®¾ç½®å¯åŠ¨é¡¹.sh
```

æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# 1. åœæ­¢æ‰€æœ‰è¿›ç¨‹å’ŒæœåŠ¡
sudo systemctl stop wushizhifu-bot 2>/dev/null
sudo systemctl stop wushipay-bot 2>/dev/null
sudo pkill -9 -f bot.py
sudo pkill -9 -f "python.*wushizhifu.*bot"
sleep 3

# 2. åˆ é™¤æ‰€æœ‰æ—§çš„æœåŠ¡æ–‡ä»¶
sudo rm -f /etc/systemd/system/*bot*.service
sudo rm -f /etc/systemd/system/*wushizhifu*.service

# 3. ç¦ç”¨æ‰€æœ‰æ—§æœåŠ¡
sudo systemctl disable wushizhifu-bot 2>/dev/null
sudo systemctl disable wushipay-bot 2>/dev/null

# 4. åˆ›å»ºæ–°çš„æœåŠ¡æ–‡ä»¶ï¼ˆä½¿ç”¨æ­£ç¡®çš„é…ç½®ï¼‰
sudo tee /etc/systemd/system/wushizhifu-bot.service > /dev/null << 'EOF'
[Unit]
Description=WuShiPay Telegram Bot
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/wushizhifu/bot
Environment="PATH=/home/ubuntu/wushizhifu/bot/venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/ubuntu/wushizhifu/bot/venv/bin/python /home/ubuntu/wushizhifu/bot/bot.py
ExecReload=/bin/kill -HUP $MAINPID

# é‡è¦ï¼šæ”¹ä¸º on-failureï¼Œè€Œä¸æ˜¯ always
Restart=on-failure
RestartSec=10
StartLimitInterval=300
StartLimitBurst=5

# æ—¥å¿—
StandardOutput=journal
StandardError=journal
SyslogIdentifier=wushizhifu-bot

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF

# 5. é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# 6. å¯ç”¨æœåŠ¡
sudo systemctl enable wushizhifu-bot

# 7. ç¡®è®¤æ²¡æœ‰è¿›ç¨‹
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥æ²¡æœ‰ä»»ä½•è¾“å‡º
```

### æ­¥éª¤ 3ï¼šå¯åŠ¨å¹¶éªŒè¯

```bash
# 1. å¯åŠ¨æœåŠ¡
sudo systemctl start wushizhifu-bot

# 2. ç«‹å³æ£€æŸ¥è¿›ç¨‹æ•°ï¼ˆç­‰å¾… 2 ç§’åŽï¼‰
sleep 2
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep | wc -l
# åº”è¯¥è¾“å‡º: 1

# 3. å¦‚æžœè¾“å‡ºæ˜¯ 2ï¼Œç«‹å³æ£€æŸ¥è¿›ç¨‹æ ‘
ps auxf | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status wushizhifu-bot --no-pager -l

# 5. æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u wushizhifu-bot -n 50 --no-pager
```

## ðŸ”‘ å…³é”®æ”¹åŠ¨

æ–°çš„æœåŠ¡é…ç½®ä¸Žæ—§é…ç½®çš„ä¸»è¦åŒºåˆ«ï¼š

1. **`Restart=on-failure`** è€Œä¸æ˜¯ `Restart=always`
   - `on-failure`ï¼šåªåœ¨å¤±è´¥æ—¶é‡å¯ï¼ˆæ­£å¸¸é€€å‡ºä¸é‡å¯ï¼‰
   - `always`ï¼šä»»ä½•æ—¶å€™éƒ½é‡å¯ï¼ˆå¯èƒ½å¯¼è‡´é—®é¢˜ï¼‰

2. **æ·»åŠ äº† `StartLimitInterval` å’Œ `StartLimitBurst`**
   - é™åˆ¶é‡å¯é¢‘çŽ‡ï¼Œé˜²æ­¢æ— é™é‡å¯

3. **ç¡®ä¿åªæœ‰ä¸€ä¸ªæœåŠ¡æ–‡ä»¶**

## âš ï¸ å¦‚æžœä»ç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹

å¦‚æžœé‡æ–°è®¾ç½®åŽä»ç„¶æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼š

1. **æ£€æŸ¥æ˜¯å¦æœ‰ cron ä»»åŠ¡**ï¼š
   ```bash
   crontab -l
   sudo crontab -l
   ```

2. **æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è„šæœ¬å¯åŠ¨ Bot**ï¼š
   ```bash
   find /home/ubuntu -name "*.sh" -exec grep -l "bot.py\|python.*bot" {} \;
   ```

3. **æ£€æŸ¥è¿›ç¨‹æ ‘**ï¼Œçœ‹ä¸¤ä¸ªè¿›ç¨‹çš„å…³ç³»ï¼š
   ```bash
   ps auxf | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
   ```

4. **æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç”¨æˆ·è¿è¡Œ Bot**ï¼š
   ```bash
   ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
   ```

