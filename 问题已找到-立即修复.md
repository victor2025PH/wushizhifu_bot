# ðŸŽ¯ é—®é¢˜å·²æ‰¾åˆ°ï¼ç«‹å³ä¿®å¤

## é—®é¢˜æ ¹æº

ä»Žè¯Šæ–­ç»“æžœçœ‹ï¼Œ**æœ‰ä¸¤ä¸ª systemd æœåŠ¡åœ¨åŒæ—¶è¿è¡Œ**ï¼š

1. `wushipay-bot.service` â†’ PID 1123 (06:57 å¯åŠ¨)
2. `wushizhifu-bot.service` â†’ PID 1193 (06:58 å¯åŠ¨)

ä¸¤ä¸ªæœåŠ¡éƒ½åœ¨å¯åŠ¨åŒä¸€ä¸ª Bot è„šæœ¬ï¼Œå¯¼è‡´å†²çªï¼

## ç«‹å³ä¿®å¤æ­¥éª¤

### æ–¹æ³• 1ï¼šä½¿ç”¨è„šæœ¬ï¼ˆæŽ¨èï¼‰

```bash
cd /home/ubuntu/wushizhifu/bot
chmod +x ç«‹å³ä¿®å¤ä¸¤ä¸ªæœåŠ¡é—®é¢˜.sh
./ç«‹å³ä¿®å¤ä¸¤ä¸ªæœåŠ¡é—®é¢˜.sh
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ‰§è¡Œ

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
sudo systemctl stop wushipay-bot
sudo systemctl stop wushizhifu-bot

# 2. å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰è¿›ç¨‹
sudo pkill -9 -f bot.py
sudo pkill -9 -f "python.*wushizhifu.*bot"
sleep 3

# 3. ç¦ç”¨å¹¶å±è”½æ—§æœåŠ¡ (wushipay-bot)
sudo systemctl disable wushipay-bot
sudo systemctl mask wushipay-bot  # é˜²æ­¢è¢«æ„å¤–å¯åŠ¨

# 4. åˆ é™¤æ—§æœåŠ¡æ–‡ä»¶
sudo rm -f /etc/systemd/system/wushipay-bot.service

# 5. æ›´æ–° wushizhifu-bot æœåŠ¡é…ç½®ï¼ˆä½¿ç”¨ on-failure è€Œä¸æ˜¯ alwaysï¼‰
sudo tee /etc/systemd/system/wushizhifu-bot.service > /dev/null << 'EOF'
[Unit]
Description=WuShiPay Telegram Bot
After=network.target
Wants=network-online.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/wushizhifu/bot
Environment="PATH=/home/ubuntu/wushizhifu/bot/venv/bin:/usr/local/bin:/usr/bin:/bin"
ExecStart=/home/ubuntu/wushizhifu/bot/venv/bin/python /home/ubuntu/wushizhifu/bot/bot.py
ExecReload=/bin/kill -HUP $MAINPID

# é‡å¯ç­–ç•¥ï¼šæ”¹ä¸º on-failureï¼ˆé‡è¦ï¼ï¼‰
Restart=on-failure
RestartSec=10
StartLimitInterval=300
StartLimitBurst=5

# æ—¥å¿—
StandardOutput=journal
StandardError=journal
SyslogIdentifier=wushizhifu-bot

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF

# 6. é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# 7. å¯ç”¨æœåŠ¡
sudo systemctl enable wushizhifu-bot

# 8. ç¡®è®¤æ²¡æœ‰è¿›ç¨‹
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥æ²¡æœ‰ä»»ä½•è¾“å‡º
```

### æ­¥éª¤ 3ï¼šå¯åŠ¨å¹¶éªŒè¯

```bash
# 1. å¯åŠ¨æœåŠ¡
sudo systemctl start wushizhifu-bot

# 2. ç­‰å¾… 3 ç§’
sleep 3

# 3. æ£€æŸ¥è¿›ç¨‹æ•°ï¼ˆåº”è¯¥åªæœ‰ 1 ä¸ªï¼‰
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep | wc -l
# åº”è¯¥è¾“å‡º: 1

# 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status wushizhifu-bot --no-pager -l | head -20

# 5. æŸ¥çœ‹æ—¥å¿—ï¼ˆä¸åº”è¯¥å†æœ‰å†²çªé”™è¯¯ï¼‰
sudo journalctl -u wushizhifu-bot -n 30 --no-pager
# åº”è¯¥çœ‹åˆ°æˆåŠŸå¯åŠ¨ï¼Œæ²¡æœ‰ TelegramConflictError
```

### æ­¥éª¤ 4ï¼šéªŒè¯ä¿®å¤

```bash
# 1. ç¡®è®¤åªæœ‰ä¸€ä¸ªæœåŠ¡åœ¨è¿è¡Œ
systemctl list-units --type=service --state=running | grep bot
# åº”è¯¥åªæœ‰ wushizhifu-bot.service

# 2. ç¡®è®¤åªæœ‰ä¸€ä¸ªè¿›ç¨‹
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥åªæœ‰ 1 è¡Œè¾“å‡º

# 3. åœ¨ Telegram ä¸­æµ‹è¯•
# å‘é€ /start å‘½ä»¤ï¼Œåº”è¯¥æ­£å¸¸å“åº”
```

## å…³é”®æ”¹åŠ¨

1. **ç¦ç”¨å¹¶å±è”½ `wushipay-bot` æœåŠ¡**ï¼ˆæ—§æœåŠ¡ï¼‰
2. **åˆ é™¤æ—§æœåŠ¡æ–‡ä»¶**
3. **æ›´æ–° `wushizhifu-bot` é…ç½®**ï¼Œä½¿ç”¨ `Restart=on-failure`ï¼ˆè€Œä¸æ˜¯ `always`ï¼‰

## ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªæœåŠ¡ï¼Ÿ

å¯èƒ½æ˜¯ä¹‹å‰çš„éƒ¨ç½²è„šæœ¬åˆ›å»ºäº† `wushipay-bot.service`ï¼ŒåŽæ¥æ”¹åä¸º `wushizhifu-bot.service`ï¼Œä½†æ—§çš„æœåŠ¡æ–‡ä»¶æ²¡æœ‰è¢«åˆ é™¤ï¼Œå¯¼è‡´ä¸¤ä¸ªæœåŠ¡éƒ½åœ¨è¿è¡Œã€‚

æ‰§è¡Œä¸Šè¿°æ­¥éª¤åŽï¼Œåº”è¯¥åªä¼šæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œï¼

