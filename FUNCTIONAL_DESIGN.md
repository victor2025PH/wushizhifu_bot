# WuShiPay Bot 功能設計方案

## 📋 目錄

1. [現有按鈕功能分析](#現有按鈕功能分析)
2. [數據庫設計方案](#數據庫設計方案)
3. [核心功能設計](#核心功能設計)
4. [用戶體驗優化方案](#用戶體驗優化方案)
5. [市場產品參考與借鑒](#市場產品參考與借鑒)
6. [功能優先級與實施計劃](#功能優先級與實施計劃)

---

## 🔘 現有按鈕功能分析

### 當前按鈕佈局

```
Row 1: 💎 啟動伍拾收銀台 | Launch App (Web App)
Row 2: 💳 支付寶通道 | 🍀 微信通道
Row 3: 🤵 專屬客服 | 📜 費率標準
Row 4: 📢 官方頻道 | 💼 商務合作
```

### 功能需求定義

#### 1. 💎 啟動伍拾收銀台 (Web App)
**當前狀態**: 佔位符 URL  
**設計功能**:
- 打開 Mini App 收銀台界面
- 快速創建收款/付款訂單
- 掃碼支付功能
- 訂單狀態實時查詢

#### 2. 💳 支付寶通道
**當前狀態**: 僅提示消息  
**設計功能**:
- 進入支付寶支付流程
- 選擇支付方式（收款/付款）
- 輸入金額
- 生成支付二維碼
- 訂單狀態查詢

#### 3. 🍀 微信通道
**當前狀態**: 僅提示消息  
**設計功能**:
- 進入微信支付流程
- 選擇支付方式（收款/付款）
- 輸入金額
- 生成支付二維碼
- 訂單狀態查詢

#### 4. 📜 費率標準
**當前狀態**: 已有基本展示  
**設計功能**:
- 顯示完整費率表（已實現）
- VIP 等級說明
- 費率計算示例
- 連接計算器功能

#### 5. 🤵 專屬客服
**當前狀態**: 外部連結  
**設計功能**:
- 跳轉到客服 Telegram
- 或者：Bot 內建客服功能（轉人工/FAQ）

#### 6. 📢 官方頻道 & 💼 商務合作
**當前狀態**: 外部連結  
**設計功能**: 保持外部連結，無需改動

---

## 🗄️ 數據庫設計方案

### 數據庫選擇建議

**推薦方案**: PostgreSQL 或 SQLite（開發階段）

- **SQLite**: 輕量級，無需單獨服務器，適合初期開發
- **PostgreSQL**: 生產環境推薦，支持複雜查詢，性能優異

### 數據表設計

#### 1. 用戶表 (users)

```sql
表名: users
主鍵: user_id (BIGINT)

字段設計:
- user_id: BIGINT PRIMARY KEY          # Telegram 用戶 ID
- username: VARCHAR(255)               # Telegram 用戶名（可為空）
- first_name: VARCHAR(255)             # 名字
- last_name: VARCHAR(255)              # 姓氏
- language_code: VARCHAR(10)           # 語言代碼 (zh, en等)
- is_premium: BOOLEAN DEFAULT FALSE    # 是否 Premium 會員
- vip_level: INTEGER DEFAULT 0         # VIP 等級 (0=普通, 1-3=VIP)
- total_transactions: INTEGER DEFAULT 0 # 總交易次數
- total_amount: DECIMAL(15,2) DEFAULT 0 # 累計交易金額
- created_at: TIMESTAMP                # 首次註冊時間
- updated_at: TIMESTAMP                # 最後更新時間
- last_active_at: TIMESTAMP            # 最後活躍時間
- status: VARCHAR(20) DEFAULT 'active' # 狀態 (active, frozen, banned)

索引:
- INDEX idx_username (username)
- INDEX idx_created_at (created_at)
- INDEX idx_status (status)
```

#### 2. 交易記錄表 (transactions)

```sql
表名: transactions
主鍵: transaction_id (BIGINT AUTO_INCREMENT)

字段設計:
- transaction_id: BIGINT PRIMARY KEY AUTO_INCREMENT
- user_id: BIGINT NOT NULL             # 關聯用戶 ID
- order_id: VARCHAR(64) UNIQUE         # 訂單號（唯一）
- transaction_type: VARCHAR(20)        # 類型 (receive收款, pay付款, refund退款)
- payment_channel: VARCHAR(20)         # 支付通道 (alipay, wechat)
- amount: DECIMAL(15,2) NOT NULL       # 交易金額
- fee: DECIMAL(15,2) DEFAULT 0         # 手續費
- actual_amount: DECIMAL(15,2)         # 實際到賬金額
- currency: VARCHAR(10) DEFAULT 'CNY'  # 貨幣類型
- status: VARCHAR(20)                  # 狀態 (pending, paid, failed, refunded, cancelled)
- description: TEXT                    # 交易描述/備註
- payer_info: VARCHAR(255)             # 付款方信息（可選）
- payee_info: VARCHAR(255)             # 收款方信息（可選）
- qr_code_url: TEXT                    # 支付二維碼 URL（可選）
- payment_url: TEXT                    # 支付連結（可選）
- callback_data: JSON                  # 回調數據（可選）
- created_at: TIMESTAMP                # 創建時間
- paid_at: TIMESTAMP                   # 支付完成時間（可選）
- expired_at: TIMESTAMP                # 訂單過期時間
- updated_at: TIMESTAMP                # 最後更新時間

索引:
- INDEX idx_user_id (user_id)
- INDEX idx_order_id (order_id)
- INDEX idx_status (status)
- INDEX idx_created_at (created_at)
- INDEX idx_payment_channel (payment_channel)
- INDEX idx_user_status (user_id, status)  # 複合索引，優化查詢
```

#### 3. 費率配置表 (rate_configs)

```sql
表名: rate_configs
主鍵: config_id (INT AUTO_INCREMENT)

字段設計:
- config_id: INT PRIMARY KEY AUTO_INCREMENT
- channel: VARCHAR(20)                 # 通道 (alipay, wechat)
- vip_level: INTEGER DEFAULT 0         # VIP 等級 (0-3)
- rate_percentage: DECIMAL(5,4)        # 費率百分比 (0.0060 = 0.6%)
- min_amount: DECIMAL(15,2)            # 最小金額
- max_amount: DECIMAL(15,2)            # 最大金額
- is_active: BOOLEAN DEFAULT TRUE      # 是否啟用
- created_at: TIMESTAMP
- updated_at: TIMESTAMP

索引:
- INDEX idx_channel_vip (channel, vip_level)
```

#### 4. 系統日誌表 (system_logs) - 可選

```sql
表名: system_logs
主鍵: log_id (BIGINT AUTO_INCREMENT)

字段設計:
- log_id: BIGINT PRIMARY KEY AUTO_INCREMENT
- user_id: BIGINT                      # 用戶 ID（可為空，系統操作）
- action: VARCHAR(50)                  # 操作類型
- details: JSON                        # 詳細信息
- ip_address: VARCHAR(45)              # IP 地址（可選）
- created_at: TIMESTAMP

索引:
- INDEX idx_user_id (user_id)
- INDEX idx_action (action)
- INDEX idx_created_at (created_at)
```

### 數據庫關係圖

```
users (1) ─────< (N) transactions
                 │
                 ├──> user_id (外鍵)
                 ├──> 每個用戶可以有多筆交易
                 └──> 交易記錄包含用戶信息

rate_configs (獨立表)
                 ├──> 費率配置
                 └──> 不直接關聯，通過 VIP 等級和通道查詢
```

---

## 🎯 核心功能設計

### 1. 支付流程設計

#### 1.1 支付寶/微信支付流程

```
用戶點擊支付通道
    ↓
顯示支付類型選擇（收款/付款）
    ↓
輸入金額界面
    ↓
顯示費率計算（實時計算）
    ↓
確認訂單信息
    ↓
生成支付二維碼/連結
    ↓
訂單狀態輪詢/回調
    ↓
支付成功通知
    ↓
更新交易記錄
```

#### 1.2 交互設計

**步驟 1: 選擇支付類型**
```
💳 請選擇支付類型：

[💰 收款] [💸 付款]

收款：別人向您付款
付款：您向別人付款
```

**步驟 2: 輸入金額**
```
💰 請輸入收款金額：

格式：數字（如：100.50）
最小金額：¥1
最大金額：¥500,000

[使用計算器] [確認金額]
```

**步驟 3: 費率計算顯示**
```
📊 訂單詳情：

交易金額：¥100.00
手續費（0.6%）：¥0.60
實際到賬：¥99.40

[確認創建訂單] [返回修改]
```

**步驟 4: 支付二維碼/連結**
```
✅ 訂單已創建

訂單號：WS2025012412345678
金額：¥100.00
手續費：¥0.60
實付：¥99.40

[查看二維碼] [複製支付連結] [查看訂單詳情]
```

### 2. 交易記錄查詢功能

#### 2.1 主界面

```
📜 交易記錄

[🔍 查詢記錄] [📊 統計分析] [💾 導出數據]

快速篩選：
[全部] [收款] [付款] [今日] [本週] [本月]
```

#### 2.2 查詢界面設計

**方案 A: 分頁列表（推薦）**
```
📜 交易記錄（共 25 筆）

【2025-01-24 今日】
✅ 收款 ¥1,000.00 | 支付寶 | 15:30:25
  訂單號：WS2025012412345678

✅ 付款 ¥500.00 | 微信 | 14:20:10
  訂單號：WS2025012412345679

【2025-01-23】
✅ 收款 ¥2,000.00 | 支付寶 | 18:45:30
  ...

[上一頁] [下一頁] [返回主頁]
```

**方案 B: 篩選查詢**
```
🔍 查詢交易記錄

請選擇篩選條件：

時間範圍：
[今天] [本週] [本月] [自定義]

交易類型：
[全部] [收款] [付款] [退款]

支付通道：
[全部] [支付寶] [微信]

狀態：
[全部] [成功] [失敗] [處理中]

[開始查詢]
```

#### 2.3 交易詳情頁面

```
📋 訂單詳情

訂單號：WS2025012412345678
狀態：✅ 支付成功
類型：收款
通道：支付寶
金額：¥1,000.00
手續費：¥6.00
實收金額：¥994.00
創建時間：2025-01-24 15:30:25
支付時間：2025-01-24 15:30:42
交易時效：17 秒

[分享訂單] [下載憑證] [返回]
```

### 3. 計算器功能設計

#### 3.1 功能定位

- **費率計算器**: 計算手續費和實際到賬金額
- **匯率計算器**: USDT/CNY 等匯率轉換
- **批量計算器**: 多筆交易計算

#### 3.2 界面設計

**主計算器界面**
```
🧮 伍拾支付計算器

[💰 費率計算] [💱 匯率轉換] [📊 批量計算]

─────────────────
費率計算器
─────────────────

交易金額：¥______
支付通道：[支付寶 ▼]
VIP 等級：[普通 ▼]

[計算]

結果：
手續費率：0.60%
手續費：¥0.00
實際到賬：¥0.00

[創建訂單] [重新計算]
```

**費率計算邏輯**
```
手續費 = 交易金額 × 費率百分比
實際到賬 = 交易金額 - 手續費

例如：
交易金額：¥1,000
費率：0.6%
手續費：¥1,000 × 0.006 = ¥6.00
實際到賬：¥1,000 - ¥6.00 = ¥994.00
```

**匯率轉換器**
```
💱 匯率轉換器

從：[USDT ▼]  →  到：[CNY ▼]

金額：______

當前匯率：1 USDT = 7.42 CNY
（實時更新）

[轉換]

結果：
100 USDT = ¥742.00 CNY
（不包含手續費）

[使用此金額創建訂單]
```

### 4. 鍵盤重新設計方案

#### 方案 A: 保持簡潔（推薦）

```
主鍵盤（4行）：
Row 1: 💎 收銀台
Row 2: 💳 支付寶 | 🍀 微信
Row 3: 📜 交易記錄 | 🧮 計算器
Row 4: 📊 統計 | ⚙️ 設置
```

#### 方案 B: 功能分組

```
主鍵盤（5行）：
Row 1: 💎 收銀台
Row 2: 💳 支付寶 | 🍀 微信
Row 3: 📜 交易記錄 | 🔍 查詢訂單
Row 4: 🧮 費率計算 | 💱 匯率轉換
Row 5: 📊 統計 | ⚙️ 設置 | 🤵 客服
```

#### 方案 C: 動態鍵盤（根據用戶狀態）

**新用戶**:
```
Row 1: 💎 收銀台
Row 2: 💳 支付寶 | 🍀 微信
Row 3: 📜 費率標準 | 🧮 計算器
Row 4: 🤵 客服 | 📢 官方頻道
```

**活躍用戶**:
```
Row 1: 💎 收銀台
Row 2: 💳 支付寶 | 🍀 微信
Row 3: 📜 交易記錄 | 🧮 計算器
Row 4: 📊 統計 | ⚙️ 設置
```

---

## 🎨 用戶體驗優化方案

### 1. 交互優化

#### 1.1 快速操作
- **快捷金額**: 提供常用金額按鈕（100, 500, 1000, 5000）
- **歷史金額**: 記錄用戶常用金額，快速選擇
- **一鍵重複**: 重複上一筆交易

#### 1.2 狀態反饋
- **即時響應**: 所有操作都有即時反饋
- **進度提示**: 長時間操作顯示進度
- **狀態更新**: 訂單狀態實時更新

#### 1.3 錯誤處理
- **友好提示**: 清晰的錯誤提示和解決建議
- **重試機制**: 失敗操作可快速重試
- **驗證提示**: 輸入驗證即時反饋

### 2. 視覺優化

#### 2.1 消息格式
- **統一風格**: 所有消息使用統一的格式
- **圖標使用**: 適當使用 emoji 增強可讀性
- **分組顯示**: 相關信息分組展示

#### 2.2 信息層次
- **重要信息突出**: 金額、狀態等關鍵信息醒目
- **次要信息收縮**: 詳細信息可展開查看
- **視覺引導**: 清晰的視覺引導用戶操作

### 3. 性能優化

#### 3.1 響應速度
- **異步處理**: 耗時操作異步處理
- **緩存機制**: 頻繁查詢數據緩存
- **數據分頁**: 大量數據分頁加載

#### 3.2 資源優化
- **圖片優化**: 二維碼等圖片壓縮
- **數據庫索引**: 優化查詢性能
- **連接池**: 數據庫連接池管理

### 4. 個性化功能

#### 4.1 用戶偏好
- **默認通道**: 記住用戶常用支付通道
- **金額偏好**: 記錄常用金額
- **語言設置**: 多語言支持（未來）

#### 4.2 智能推薦
- **VIP 升級提醒**: 接近 VIP 門檻時提醒
- **優惠通知**: 新優惠活動通知
- **使用建議**: 根據使用習慣提供建議

---

## 🌟 市場產品參考與借鑒

### 1. 參考產品分析

#### 1.1 支付寶小程序
**優點**:
- ✅ 簡潔的界面設計
- ✅ 清晰的流程引導
- ✅ 實時的狀態更新
- ✅ 完整的交易記錄

**借鑒**:
- 支付流程簡化到 3-4 步
- 實時顯示費率和手續費
- 訂單狀態實時更新

#### 1.2 微信支付
**優點**:
- ✅ 快速的支付體驗
- ✅ 清晰的金額顯示
- ✅ 便捷的查詢功能

**借鑒**:
- 支付碼生成快速
- 訂單詳情完整
- 交易記錄易於查找

#### 1.3 Telegram 優秀支付 Bot
**參考案例**:
- CryptoBot (加密貨幣支付)
- Payment Bot (通用支付)

**借鑒**:
- 簡潔的命令式交互
- 清晰的狀態顯示
- 完整的交易歷史

### 2. 最佳實踐應用

#### 2.1 簡化流程
- **最少步驟**: 支付流程不超過 4 步
- **預設值**: 智能預設常用選項
- **快捷操作**: 提供常用操作的快捷方式

#### 2.2 信息透明
- **費率透明**: 明確顯示所有費用
- **狀態清晰**: 訂單狀態易於理解
- **記錄完整**: 完整的交易記錄

#### 2.3 錯誤預防
- **輸入驗證**: 即時驗證用戶輸入
- **確認機制**: 重要操作需要確認
- **防誤操作**: 防止用戶誤操作

#### 2.4 用戶反饋
- **即時反饋**: 所有操作都有反饋
- **狀態通知**: 訂單狀態變化及時通知
- **錯誤提示**: 清晰的錯誤信息和解決方案

---

## 📅 功能優先級與實施計劃

### 階段一：核心功能（優先級：高）

1. **數據庫設計與搭建** ✅
   - 設計數據表結構
   - 創建數據庫連接
   - 實現數據模型

2. **交易記錄查詢功能** ✅
   - 基本查詢界面
   - 分頁顯示
   - 交易詳情頁

3. **計算器功能** ✅
   - 費率計算器
   - 基本界面
   - 計算邏輯

### 階段二：支付功能（優先級：高）

4. **支付流程實現**
   - 支付寶通道完整流程
   - 微信通道完整流程
   - 訂單創建和管理
   - 支付狀態查詢

5. **訂單管理**
   - 訂單詳情查詢
   - 訂單狀態更新
   - 訂單取消功能

### 階段三：優化功能（優先級：中）

6. **計算器增強**
   - 匯率轉換
   - 批量計算
   - 歷史記錄

7. **交易記錄增強**
   - 高級篩選
   - 統計分析
   - 數據導出

8. **鍵盤優化**
   - 重新設計鍵盤佈局
   - 動態鍵盤
   - 快捷操作

### 階段四：高級功能（優先級：低）

9. **統計分析**
   - 交易統計
   - 圖表展示
   - 報表生成

10. **個性化功能**
    - 用戶偏好設置
    - 智能推薦
    - 個性化提醒

---

## ❓ 需要確認的問題

### 1. 功能確認

- [ ] 計算器功能是否只需要費率計算，還是需要匯率轉換？
- [ ] 交易記錄查詢是否需要支持導出功能？
- [ ] 是否需要交易統計和分析功能？
- [ ] 支付流程是否需要支持批量支付？

### 2. 數據庫確認

- [ ] 數據庫選擇：SQLite（開發）還是直接使用 PostgreSQL？
- [ ] 是否需要系統日誌表記錄所有操作？
- [ ] 交易記錄是否需要永久保存，還是定期歸檔？

### 3. 交互確認

- [ ] 鍵盤佈局選擇哪個方案？（A/B/C）
- [ ] 支付流程是否需要確認步驟？
- [ ] 計算器是獨立界面還是嵌入支付流程？

### 4. 業務邏輯確認

- [ ] VIP 等級如何判定？（累計交易金額？）
- [ ] 訂單過期時間設置為多長？（建議：15-30分鐘）
- [ ] 是否需要支持退款功能？

---

## 📝 下一步行動

請您：
1. 審閱上述方案
2. 確認功能需求和優先級
3. 回答需要確認的問題
4. 提出任何修改建議

確認後，我將開始實施代碼開發。

