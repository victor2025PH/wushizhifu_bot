# å®Œæ•´è¯Šæ–­å’Œä¿®å¤æ–¹æ¡ˆ - å¤šä¸ª Bot å®ä¾‹å†²çª

## ğŸ” é—®é¢˜åˆ†æ

ä»æ—¥å¿—çœ‹ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

1. **TelegramConflictError**ï¼šæ˜ç¡®è¡¨ç¤ºæœ‰å¤šä¸ª Bot å®ä¾‹åœ¨è¿è¡Œ
2. **TypeError: get_main_keyboard()**ï¼šæœåŠ¡å™¨ä»£ç æœªæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
3. **è¿›ç¨‹ PID 1059**ï¼šå³ä½¿æ‰§è¡Œäº† pkillï¼Œä»ç„¶æœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œ

## ğŸ“‹ æ‰€æœ‰å¯èƒ½çš„å¯åŠ¨æ–¹å¼

### 1. systemd æœåŠ¡
- `/etc/systemd/system/wushizhifu-bot.service`
- å¯èƒ½è‡ªåŠ¨é‡å¯å¯¼è‡´å¤šä¸ªå®ä¾‹

### 2. æ‰‹åŠ¨è¿è¡Œçš„è¿›ç¨‹
- ç›´æ¥è¿è¡Œ `python bot.py`
- é€šè¿‡è™šæ‹Ÿç¯å¢ƒè¿è¡Œ `venv/bin/python bot.py`
- ä»æˆªå›¾çœ‹åˆ°ï¼šPID 1059 åœ¨ 02:23 å¯åŠ¨ï¼Œå¯èƒ½æ˜¯æ‰‹åŠ¨å¯åŠ¨çš„

### 3. screen/tmux ä¼šè¯
- å¯èƒ½æœ‰äººé€šè¿‡ screen æˆ– tmux åå°è¿è¡Œäº† Bot

### 4. cron ä»»åŠ¡
- å¯èƒ½æœ‰å®šæ—¶ä»»åŠ¡å¯åŠ¨ Bot

### 5. shell å¯åŠ¨æ–‡ä»¶
- `.bashrc`, `.profile` ç­‰å¯èƒ½åœ¨ç™»å½•æ—¶å¯åŠ¨ Bot

### 6. supervisord æˆ–å…¶ä»–å®ˆæŠ¤è¿›ç¨‹
- å¦‚æœæœ‰å…¶ä»–è¿›ç¨‹ç®¡ç†å·¥å…·

## ğŸ› ï¸ å®Œæ•´ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1ï¼šå…¨é¢æ£€æŸ¥æ‰€æœ‰å¯åŠ¨é¡¹

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
# ä¸Šä¼ å¹¶è¿è¡Œæ£€æŸ¥è„šæœ¬
cd /home/ubuntu/wushizhifu/bot
chmod +x å…¨é¢æ£€æŸ¥æ‰€æœ‰å¯åŠ¨é¡¹.sh
./å…¨é¢æ£€æŸ¥æ‰€æœ‰å¯åŠ¨é¡¹.sh
```

æˆ–è€…æ‰‹åŠ¨æ£€æŸ¥ï¼š

```bash
# 1. æ£€æŸ¥æ‰€æœ‰ Bot è¿›ç¨‹ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# è®°å½•æ‰€æœ‰ PID å’Œå¯åŠ¨æ—¶é—´

# 2. æ£€æŸ¥ systemd æœåŠ¡
sudo systemctl status wushizhifu-bot
systemctl list-units --all | grep bot

# 3. æ£€æŸ¥ screen/tmux
screen -ls
tmux ls

# 4. æ£€æŸ¥ cron
crontab -l
sudo crontab -l
ls -la /etc/cron.d/ /etc/cron.daily/ /etc/cron.hourly/

# 5. æ£€æŸ¥å¯åŠ¨è„šæœ¬
find /home/ubuntu -name "*.sh" -type f -exec grep -l "bot.py\|python.*bot" {} \;

# 6. æ£€æŸ¥ shell å¯åŠ¨æ–‡ä»¶
grep -r "bot\|python.*wushizhifu" ~/.bashrc ~/.profile ~/.bash_profile 2>/dev/null
```

### æ­¥éª¤ 2ï¼šå¼ºåˆ¶åœæ­¢æ‰€æœ‰å®ä¾‹

```bash
# æ–¹æ³• 1ï¼šä½¿ç”¨æä¾›çš„è„šæœ¬
chmod +x å¼ºåˆ¶åœæ­¢æ‰€æœ‰å®ä¾‹.sh
./å¼ºåˆ¶åœæ­¢æ‰€æœ‰å®ä¾‹.sh

# æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ‰§è¡Œ
# 1. åœæ­¢ systemd æœåŠ¡
sudo systemctl stop wushizhifu-bot

# 2. å¼ºåˆ¶ç»ˆæ­¢æ‰€æœ‰è¿›ç¨‹ï¼ˆæ ¹æ®æ­¥éª¤1çš„ç»“æœï¼‰
# æ‰¾åˆ°æ‰€æœ‰ PID åï¼Œé€ä¸ªç»ˆæ­¢
sudo kill -9 <PID1> <PID2> <PID3> ...

# æˆ–è€…ä¸€æ¬¡æ€§ç»ˆæ­¢æ‰€æœ‰
sudo pkill -9 -f bot.py
sudo pkill -9 -f "python.*wushizhifu.*bot"

# 3. ç»ˆæ­¢ screen/tmux ä¼šè¯
screen -ls | grep bot | awk '{print $1}' | xargs -I {} screen -S {} -X quit
tmux ls | grep bot | cut -d: -f1 | xargs -I {} tmux kill-session -t {}

# 4. ç¡®è®¤æ²¡æœ‰æ®‹ç•™è¿›ç¨‹
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥æ²¡æœ‰ä»»ä½•è¾“å‡º
```

### æ­¥éª¤ 3ï¼šæ›´æ–°ä»£ç 

```bash
cd /home/ubuntu/wushizhifu/bot

# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. ç¡®è®¤ä»£ç å·²æ›´æ–°
grep "def get_main_keyboard(user_id" keyboards/main_kb.py
# åº”è¯¥çœ‹åˆ°ï¼šdef get_main_keyboard(user_id: int = None, is_admin: bool = False)

# 3. æ¸…é™¤ Python ç¼“å­˜
find . -name "*.pyc" -delete
find . -name "__pycache__" -type d -exec rm -r {} + 2>/dev/null || true
```

### æ­¥éª¤ 4ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªå¯åŠ¨æ–¹å¼

#### 4.1 æ£€æŸ¥å¹¶ä¿®å¤ systemd æœåŠ¡

```bash
# æ£€æŸ¥æœåŠ¡æ–‡ä»¶
cat /etc/systemd/system/wushizhifu-bot.service

# ç¡®ä¿é…ç½®æ­£ç¡®ï¼ˆåº”è¯¥åªæœ‰ä¸€ä¸ªï¼‰
[Unit]
Description=WuShiPay Telegram Bot
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/wushizhifu/bot
ExecStart=/home/ubuntu/wushizhifu/bot/venv/bin/python /home/ubuntu/wushizhifu/bot/bot.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 4.2 åˆ é™¤æˆ–ç¦ç”¨å…¶ä»–å¯åŠ¨æ–¹å¼

```bash
# å¦‚æœæœ‰ cron ä»»åŠ¡ï¼Œåˆ é™¤
crontab -l | grep -v bot | crontab -
sudo crontab -l | grep -v bot | sudo crontab -

# å¦‚æœæœ‰å¯åŠ¨è„šæœ¬ï¼Œé‡å‘½åæˆ–åˆ é™¤
# ï¼ˆå…ˆç¡®è®¤æ˜¯å¦è¿˜éœ€è¦ï¼‰

# ä» shell å¯åŠ¨æ–‡ä»¶ä¸­åˆ é™¤ Bot ç›¸å…³å‘½ä»¤
# ï¼ˆå¦‚æœå‘ç°çš„è¯ï¼‰
```

### æ­¥éª¤ 5ï¼šé‡æ–°å¯åŠ¨ï¼ˆä»…é€šè¿‡ systemdï¼‰

```bash
# 1. é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# 2. å¯ç”¨æœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰
sudo systemctl enable wushizhifu-bot

# 3. å¯åŠ¨æœåŠ¡
sudo systemctl start wushizhifu-bot

# 4. ç­‰å¾…å¹¶æ£€æŸ¥
sleep 5
sudo systemctl status wushizhifu-bot

# 5. ç¡®è®¤åªæœ‰ä¸€ä¸ªè¿›ç¨‹
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# åº”è¯¥åªæœ‰ 1 ä¸ªè¿›ç¨‹
```

### æ­¥éª¤ 6ï¼šéªŒè¯ä¿®å¤

```bash
# 1. æ£€æŸ¥è¿›ç¨‹æ•°ï¼ˆåº”è¯¥æ˜¯ 1ï¼‰
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep | wc -l
# åº”è¯¥è¾“å‡º: 1

# 2. æ£€æŸ¥æ—¥å¿—ï¼ˆä¸åº”è¯¥æœ‰å†²çªé”™è¯¯ï¼‰
sudo journalctl -u wushizhifu-bot -n 100 --no-pager | grep -i conflict
# åº”è¯¥æ²¡æœ‰è¾“å‡º

# 3. æ£€æŸ¥æ—¥å¿—ï¼ˆä¸åº”è¯¥æœ‰ TypeErrorï¼‰
sudo journalctl -u wushizhifu-bot -n 100 --no-pager | grep -i "typeerror\|get_main_keyboard"
# åº”è¯¥æ²¡æœ‰è¾“å‡º

# 4. åœ¨ Telegram ä¸­æµ‹è¯•
# å‘é€ /start å‘½ä»¤ï¼Œåº”è¯¥æ­£å¸¸å“åº”
```

## ğŸ”’ é¢„é˜²æªæ–½

### 1. åˆ›å»ºç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ª Bot å®ä¾‹
COUNT=$(ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep | wc -l)
if [ "$COUNT" -gt 1 ]; then
    echo "è­¦å‘Šï¼šå‘ç° $COUNT ä¸ª Bot å®ä¾‹ï¼"
    # å¯ä»¥å‘é€é€šçŸ¥æˆ–è‡ªåŠ¨ä¿®å¤
fi
```

### 2. ç¦æ­¢æ‰‹åŠ¨è¿è¡Œ

åœ¨ `bot.py` å¼€å¤´æ·»åŠ æ£€æŸ¥ï¼š

```python
import os
import sys

# æ£€æŸ¥æ˜¯å¦é€šè¿‡ systemd è¿è¡Œ
if not os.environ.get('SYSTEMD_EXEC_PID'):
    print("é”™è¯¯ï¼šBot å¿…é¡»é€šè¿‡ systemd æœåŠ¡è¿è¡Œï¼")
    print("è¯·ä½¿ç”¨: sudo systemctl start wushizhifu-bot")
    sys.exit(1)
```

### 3. è®¾ç½®æ­£ç¡®çš„æƒé™

```bash
# ç¡®ä¿åªæœ‰ systemd å¯ä»¥å¯åŠ¨
chmod 644 /etc/systemd/system/wushizhifu-bot.service
```

## ğŸ“ å…³é”®è¦ç‚¹

1. **æ°¸è¿œåªé€šè¿‡ systemd å¯åŠ¨ Bot**ï¼Œä¸è¦æ‰‹åŠ¨è¿è¡Œ `python bot.py`
2. **å¯åŠ¨å‰å¿…é¡»æ£€æŸ¥**æ˜¯å¦æœ‰å…¶ä»–å®ä¾‹åœ¨è¿è¡Œ
3. **ç¡®ä¿ä»£ç å·²æ›´æ–°**åˆ°æœ€æ–°ç‰ˆæœ¬
4. **å®šæœŸæ£€æŸ¥**è¿›ç¨‹æ•°é‡ï¼Œåº”è¯¥å§‹ç»ˆæ˜¯ 1

## ğŸš¨ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

å¦‚æœæ‰§è¡Œä¸Šè¿°æ­¥éª¤åä»æœ‰å†²çªï¼š

1. **æ£€æŸ¥å…¶ä»–æœåŠ¡å™¨**ï¼šç¡®ä¿æ²¡æœ‰å…¶ä»–æœåŠ¡å™¨åœ¨ä½¿ç”¨åŒä¸€ä¸ª Bot Token
2. **é‡æ–°ç”Ÿæˆ Token**ï¼šé€šè¿‡ BotFather ç”Ÿæˆæ–° Tokenï¼ˆæœ€åæ‰‹æ®µï¼‰
3. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®ä¿æ²¡æœ‰å¤šä¸ªç½‘ç»œè¿æ¥åŒæ—¶è¿æ¥åˆ° Telegram API

