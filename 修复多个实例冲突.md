# ä¿®å¤ Bot å¤šä¸ªå®ä¾‹å†²çªé—®é¢˜

## é—®é¢˜è¯Šæ–­

æ—¥å¿—æ˜¾ç¤ºï¼š`TelegramConflictError: Conflict: terminated by other getUpdates request; make sure that only one bot instance is running`

è¿™è¡¨æ˜æœ‰å¤šä¸ª Bot è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œå¯¼è‡´å†²çªã€‚

## è§£å†³æ­¥éª¤

### 1. æ£€æŸ¥æ‰€æœ‰ Bot è¿›ç¨‹

```bash
# æŸ¥æ‰¾æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ bot.py è¿›ç¨‹
ps aux | grep bot.py | grep -v grep

# æˆ–è€…ä½¿ç”¨ pgrep
pgrep -f bot.py
```

### 2. åœæ­¢æ‰€æœ‰ Bot è¿›ç¨‹

```bash
# æ–¹æ³• 1: ä½¿ç”¨ systemctl åœæ­¢æœåŠ¡ï¼ˆæ¨èï¼‰
sudo systemctl stop wushizhifu-bot

# æ–¹æ³• 2: å¦‚æœæœåŠ¡æ²¡æœ‰æ­£ç¡®åœæ­¢ï¼Œæ‰‹åŠ¨æ€æ­»æ‰€æœ‰ bot.py è¿›ç¨‹
sudo pkill -f bot.py

# æ–¹æ³• 3: å¦‚æœæ–¹æ³•2ä¸è¡Œï¼Œä½¿ç”¨ killall
sudo killall -9 python3

# ç¡®è®¤æ‰€æœ‰è¿›ç¨‹å·²åœæ­¢
ps aux | grep bot.py | grep -v grep
# åº”è¯¥æ²¡æœ‰ä»»ä½•è¾“å‡º
```

### 3. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–¹å¼è¿è¡Œçš„ Bot

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰ nohup æˆ– screen/tmux ä¼šè¯
ps aux | grep -E "(nohup|screen|tmux).*bot"
pgrep -f "nohup.*bot"
screen -ls
tmux ls

# å¦‚æœå‘ç° screen ä¼šè¯ï¼Œå…³é—­å®ƒ
screen -r <session_id>  # ç„¶åæŒ‰ Ctrl+D é€€å‡º
# æˆ–è€…ç›´æ¥æ€æ­»
screen -X -S <session_id> quit

# å¦‚æœå‘ç° tmux ä¼šè¯ï¼Œå…³é—­å®ƒ
tmux kill-session -t <session_name>
```

### 4. ç¡®è®¤æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status wushizhifu-bot

# åº”è¯¥æ˜¾ç¤º "inactive (dead)" æˆ– "stopped"
```

### 5. æ¸…ç†å¹¶é‡æ–°å¯åŠ¨

```bash
# è¿›å…¥ Bot ç›®å½•
cd /home/ubuntu/wushizhifu/bot

# ç¡®è®¤æ²¡æœ‰æ®‹ç•™è¿›ç¨‹
ps aux | grep bot.py | grep -v grep

# é‡æ–°å¯åŠ¨æœåŠ¡
sudo systemctl start wushizhifu-bot

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status wushizhifu-bot

# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
sudo journalctl -u wushizhifu-bot -n 50 --no-pager
```

### 6. éªŒè¯å¯åŠ¨æˆåŠŸ

æˆåŠŸå¯åŠ¨åï¼Œæ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š

```
âœ… Database initialized
âœ… Bot commands set successfully
âœ… Menu button set: 'æ‰“å¼€åº”ç”¨' -> https://50zf.usdt2026.cc?view=dashboard
âœ… Bot description set successfully
ğŸ¤– Bot: @wushi68_bot (ä¼æ‹¾æ”¯ä»˜)
âœ… WuShiPay System Initialized Successfully
```

**ä¸åº”è¯¥å†çœ‹åˆ°** `TelegramConflictError` é”™è¯¯ã€‚

## é¢„é˜²æªæ–½

### 1. ç¡®ä¿åªä½¿ç”¨ systemd æœåŠ¡è¿è¡Œ Bot

**ä¸è¦**ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è¿è¡Œ Botï¼š
- âŒ `python bot.py`ï¼ˆç›´æ¥åœ¨ç»ˆç«¯è¿è¡Œï¼‰
- âŒ `nohup python bot.py &`ï¼ˆåå°è¿è¡Œï¼‰
- âŒ `screen` æˆ– `tmux` ä¼šè¯ä¸­è¿è¡Œ
- âŒ æ‰‹åŠ¨å¯åŠ¨å¤šä¸ªå®ä¾‹

**åº”è¯¥**åªä½¿ç”¨ï¼š
- âœ… `sudo systemctl start wushizhifu-bot`ï¼ˆé€šè¿‡ systemd æœåŠ¡ï¼‰

### 2. æ£€æŸ¥ systemd æœåŠ¡é…ç½®

ç¡®è®¤æœåŠ¡é…ç½®æ­£ç¡®ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡æ–‡ä»¶
cat /etc/systemd/system/wushizhifu-bot.service

# åº”è¯¥ç±»ä¼¼è¿™æ ·ï¼š
# [Service]
# Type=simple
# ExecStart=/home/ubuntu/wushizhifu/bot/venv/bin/python /home/ubuntu/wushizhifu/bot/bot.py
# Restart=always
```

### 3. å¦‚æœæœåŠ¡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º

```bash
cd /home/ubuntu/wushizhifu/bot

# å¦‚æœæœ‰åˆ›å»ºæœåŠ¡çš„è„šæœ¬ï¼Œè¿è¡Œå®ƒ
./åˆ›å»ºæœåŠ¡å¹¶å¯åŠ¨.sh

# æˆ–è€…æ‰‹åŠ¨åˆ›å»º
sudo tee /etc/systemd/system/wushizhifu-bot.service > /dev/null << 'EOF'
[Unit]
Description=WuShiPay Telegram Bot
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/wushizhifu/bot
Environment="PATH=/home/ubuntu/wushizhifu/bot/venv/bin"
ExecStart=/home/ubuntu/wushizhifu/bot/venv/bin/python /home/ubuntu/wushizhifu/bot/bot.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡
sudo systemctl enable wushizhifu-bot

# å¯åŠ¨æœåŠ¡
sudo systemctl start wushizhifu-bot
```

## å¿«é€Ÿä¿®å¤å‘½ä»¤ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

```bash
# åœæ­¢æ‰€æœ‰ Bot è¿›ç¨‹
sudo systemctl stop wushizhifu-bot
sudo pkill -f bot.py
sleep 2

# ç¡®è®¤è¿›ç¨‹å·²åœæ­¢
ps aux | grep bot.py | grep -v grep || echo "âœ… æ‰€æœ‰è¿›ç¨‹å·²åœæ­¢"

# é‡æ–°å¯åŠ¨æœåŠ¡
cd /home/ubuntu/wushizhifu/bot
sudo systemctl start wushizhifu-bot

# ç­‰å¾…å‡ ç§’åæŸ¥çœ‹æ—¥å¿—
sleep 3
sudo journalctl -u wushizhifu-bot -n 30 --no-pager
```

## æ•…éšœæ’é™¤

### å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ª systemd æœåŠ¡**ï¼š
```bash
sudo systemctl list-units | grep -i bot
```

2. **æ£€æŸ¥ç«¯å£å ç”¨**ï¼ˆå¦‚æœä½¿ç”¨äº† webhookï¼‰ï¼š
```bash
sudo netstat -tulpn | grep :8443
# æˆ–
sudo lsof -i :8443
```

3. **æ£€æŸ¥ç¯å¢ƒå˜é‡**ï¼š
```bash
cd /home/ubuntu/wushizhifu/bot
cat .env | grep BOT_TOKEN
# ç¡®è®¤åªæœ‰ä¸€ä¸ª BOT_TOKEN
```

4. **æŸ¥çœ‹å®Œæ•´æ—¥å¿—**ï¼š
```bash
sudo journalctl -u wushizhifu-bot -f
```

