# ⚠️ 重要：立即更新到服务器

## 问题原因

**本地代码已更新并推送到 GitHub，但服务器上的代码还是旧版本！**

这就是为什么：
- ❌ 机器人的信息栏按钮没有更新
- ❌ 信息面板的"打开应用"按钮没有更新
- ❌ Bot 功能按钮还是跳转到 MiniApp

## ✅ 解决方案：在服务器上更新代码

### 方法一：使用更新脚本（推荐）

```bash
# SSH 连接到服务器后执行
cd /home/ubuntu/wushizhifu/bot
wget -O update.sh https://raw.githubusercontent.com/victor2025PH/wushizhifu_bot/main/服务器更新步骤.sh
chmod +x update.sh
./update.sh
```

### 方法二：手动执行命令

```bash
# 1. 进入 Bot 目录
cd /home/ubuntu/wushizhifu/bot

# 2. 拉取最新代码
git pull origin main

# 3. 清除 Python 缓存（重要！）
find . -name "*.pyc" -delete
find . -name "__pycache__" -type d -exec rm -r {} + 2>/dev/null || true

# 4. 重启 Bot 服务
sudo systemctl restart wushizhifu-bot

# 5. 等待 3 秒
sleep 3

# 6. 查看日志确认菜单按钮已设置
sudo journalctl -u wushizhifu-bot -n 50 --no-pager | grep -E "(Menu button|Bot description|WuShiPay System Initialized)"
```

## 📋 验证步骤

更新完成后，在 Telegram 中验证：

### 1. 验证菜单按钮（信息面板的"打开应用"）

**位置**：
- Bot 个人资料页面（点击 Bot 头像）
- 聊天界面顶部

**应该看到**：
- ✅ 按钮文本：**"打开应用"**
- ✅ 点击后打开 MiniApp (dashboard)

**检查日志**：
```bash
sudo journalctl -u wushizhifu-bot -n 50 | grep "Menu button"
```

应该看到：
```
✅ Menu button set: '打开应用' -> https://50zf.usdt2026.cc?view=dashboard
```

### 2. 验证 Bot 描述（信息栏）

**位置**：
- Bot 个人资料页面

**应该看到**：
- ✅ 描述包含："伍拾支付 - Telegram 生态中领先的数字资产支付解决方案"
- ✅ 包含功能列表

**检查日志**：
```bash
sudo journalctl -u wushizhifu-bot -n 50 | grep "Bot description"
```

应该看到：
```
✅ Bot description set successfully
```

### 3. 验证主键盘按钮（在消息中）

发送 `/start` 命令后，应该看到：

- ✅ **💎 启动伍拾收银台** - 打开 MiniApp（保留）
- ✅ **💳 支付宝** - Bot 内部功能（不再跳转 MiniApp）
- ✅ **🍀 微信支付** - Bot 内部功能（不再跳转 MiniApp）
- ✅ **📜 交易记录** - Bot 内部功能（不再跳转 MiniApp）
- ✅ **🧮 汇率计算器** - Bot 内部功能（不再跳转 MiniApp）
- ✅ **💰 我的钱包** - Bot 内部功能（新增）
- ✅ **⚙️ 个人设置** - Bot 内部功能（新增）

**测试**：
1. 点击「💳 支付宝」→ 应该显示支付类型选择（不跳转 MiniApp）
2. 点击「📜 交易记录」→ 应该显示交易列表（不跳转 MiniApp）
3. 点击「💰 我的钱包」→ 应该显示钱包信息（不跳转 MiniApp）

## 🔍 如果更新后仍然没有变化

### 检查 1：确认代码已更新

```bash
cd /home/ubuntu/wushizhifu/bot
git log --oneline -3
```

应该看到最新提交：
```
98d4d0d 实现 Bot 功能完整化：所有按钮改为 Bot 内部功能，新增钱包和设置功能，统一为简体中文
```

### 检查 2：确认服务已重启

```bash
sudo systemctl status wushizhifu-bot
```

应该显示：
- `Active: active (running)`
- `Main PID: <number>` 是最新的进程 ID

### 检查 3：查看启动日志

```bash
sudo journalctl -u wushizhifu-bot -n 100 --no-pager
```

查找：
- ✅ `✅ Menu button set: '打开应用'` - 菜单按钮已设置
- ✅ `✅ Bot description set successfully` - Bot 描述已设置
- ✅ `✅ WuShiPay System Initialized Successfully` - Bot 已成功启动

### 检查 4：清除 Telegram 缓存

如果代码和服务都正确，但 Telegram 仍然显示旧内容：

1. **关闭 Telegram 应用**（完全退出）
2. **重新打开 Telegram**
3. **在 Bot 中发送 `/start`**（会生成新的消息和按钮）

## 📝 关键文件位置

### 菜单按钮设置
- **文件**：`wushizhifu-bot/utils/bot_setup.py`
- **函数**：`setup_menu_button()`
- **调用位置**：`bot.py` 的 `on_startup()` 函数
- **设置时机**：Bot 每次启动时自动设置

### Bot 描述设置
- **文件**：`wushizhifu-bot/utils/bot_setup.py`
- **函数**：`setup_bot_info()`
- **调用位置**：`bot.py` 的 `on_startup()` 函数
- **设置时机**：Bot 每次启动时自动设置

### 主键盘按钮
- **文件**：`wushizhifu-bot/keyboards/main_kb.py`
- **函数**：`get_main_keyboard()`
- **使用位置**：用户发送 `/start` 时显示

## ⚡ 快速修复命令（一键执行）

```bash
cd /home/ubuntu/wushizhifu/bot && \
git pull origin main && \
find . -name "*.pyc" -delete && \
find . -name "__pycache__" -type d -exec rm -r {} + 2>/dev/null || true && \
sudo systemctl restart wushizhifu-bot && \
sleep 3 && \
echo "✅ 更新完成！检查日志：" && \
sudo journalctl -u wushizhifu-bot -n 30 --no-pager | grep -E "(Menu button|Bot description|Initialized)"
```

