# WuShiPay Bot 架構說明

## 專案結構

```
wushizhifu/
├── bot.py                      # 入口點，Bot 初始化與啟動
├── config.py                   # 配置管理
├── handlers/                   # 處理器層
│   ├── __init__.py
│   └── user_handlers.py        # 用戶命令處理器
├── keyboards/                  # 鍵盤布局
│   ├── __init__.py
│   └── main_kb.py              # 主鍵盤
├── middleware/                 # 中間件層
│   ├── __init__.py
│   └── user_tracking.py        # 用戶追蹤中間件
├── services/                   # 服務層（業務邏輯）
│   ├── __init__.py
│   ├── user_service.py         # 用戶數據服務
│   └── message_service.py      # 消息生成服務
└── utils/                      # 工具函數
    ├── __init__.py
    └── text_utils.py           # 文本處理工具
```

## 架構設計原則

### 1. 分層架構

- **Handlers 層**：處理用戶交互，僅負責接收和響應
- **Services 層**：業務邏輯，處理核心功能
- **Utils 層**：可復用的工具函數
- **Middleware 層**：橫切關注點（日誌、追蹤等）

### 2. 職責分離

每個模組都有清晰的職責：
- 處理器不包含業務邏輯
- 服務層不直接處理 Telegram API
- 工具函數獨立且可測試

### 3. 專業化改進

#### 用戶追蹤
- 自動記錄用戶首次訪問時間
- 追蹤用戶活動和消息數
- 區分新用戶和回訪用戶

#### 專業消息格式
- 統一的企業級消息模板
- 動態時間問候語
- 系統狀態實時顯示
- 結構化的信息展示

#### 錯誤處理
- 全面的異常捕獲
- 專業的錯誤日誌記錄
- 用戶友好的錯誤提示

#### 日誌系統
- 結構化日誌記錄
- 用戶操作追蹤
- 系統狀態監控

## 主要功能模組

### UserService
負責用戶數據管理：
- 用戶註冊和更新
- 用戶數據查詢
- 用戶統計信息
- 新用戶檢測

### MessageService
負責生成專業消息：
- 個性化歡迎消息
- 費率信息展示
- 系統狀態消息
- 動態內容生成

### UserTrackingMiddleware
自動追蹤用戶活動：
- 自動註冊新用戶
- 更新用戶活動時間
- 統計消息數量

## 未來擴展建議

### 數據持久化
- 集成數據庫（PostgreSQL/MySQL）
- 用戶數據持久化存儲
- 交易記錄存儲

### 支付集成
- 支付寶 API 集成
- 微信支付 API 集成
- 訂單管理系統
- 支付回調處理

### 安全增強
- 用戶認證中間件
- 速率限制
- 惡意行為檢測
- 數據加密

### 管理功能
- 管理員面板
- 用戶管理
- 統計報表
- 系統監控

### 國際化
- 多語言支持
- 自動語言檢測
- 本地化消息模板

