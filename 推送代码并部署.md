# 推送代码并部署到服务器

## 当前状态

- **本地代码**：已修复 `get_main_keyboard` 函数签名
- **服务器代码**：`git pull` 显示 "Already up to date"，说明代码还没推送
- **服务器进程**：仍有 2 个 Bot 实例在运行

## 步骤 1：本地推送代码到 GitHub

在本地执行：

```bash
cd D:\wushizhifu\wushizhifu-bot

# 查看状态
git status

# 添加所有更改
git add .

# 提交
git commit -m "修复 get_main_keyboard 函数签名和 is_premium 错误"

# 推送到 GitHub
git push origin main
```

## 步骤 2：在服务器上找出并停止所有进程

在服务器上执行：

```bash
cd /home/ubuntu/wushizhifu/bot

# 方法 1：使用脚本（上传脚本后）
chmod +x 找出并停止所有进程.sh
./找出并停止所有进程.sh

# 方法 2：手动执行
# 1. 查看所有进程的详细信息
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep

# 2. 记录所有 PID
PIDS=$(ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep | awk '{print $2}')
echo "发现的 PID: $PIDS"

# 3. 停止 systemd 服务
sudo systemctl stop wushizhifu-bot

# 4. 逐个终止进程
for pid in $PIDS; do
    echo "终止 PID: $pid"
    sudo kill -9 $pid
done

# 5. 再次检查
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# 应该没有任何输出
```

## 步骤 3：在服务器上更新代码

```bash
cd /home/ubuntu/wushizhifu/bot

# 拉取最新代码
git pull origin main

# 确认代码已更新
grep "def get_main_keyboard(user_id" keyboards/main_kb.py
# 应该看到：def get_main_keyboard(user_id: int = None, is_admin: bool = False)

# 清除缓存
find . -name "*.pyc" -delete
find . -name "__pycache__" -type d -exec rm -r {} + 2>/dev/null || true
```

## 步骤 4：重新启动（仅一个实例）

```bash
# 确保没有残留进程
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep
# 应该没有任何输出

# 重新加载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start wushizhifu-bot

# 等待
sleep 5

# 验证只有一个进程
ps aux | grep -E "bot\.py|python.*wushizhifu.*bot" | grep -v grep | wc -l
# 应该输出: 1

# 查看日志
sudo journalctl -u wushizhifu-bot -n 50 --no-pager
```

## 关键要点

1. **必须先推送代码**，服务器才能 `git pull` 到最新版本
2. **必须找出所有进程的 PID**，然后逐个终止
3. **确保只有一个实例**在运行

