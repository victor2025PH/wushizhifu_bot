# 分享活动系统部署说明

## ✅ 已完成功能

### 1. 数据库表结构
- ✅ `referral_codes` - 推荐码表
- ✅ `referrals` - 推荐关系表
- ✅ `referral_rewards` - 奖励记录表
- ✅ `lottery_entries` - 抽奖记录表
- ✅ `monthly_rankings` - 月度排行榜表

### 2. 核心功能
- ✅ 推荐码生成和管理
- ✅ 推荐关系记录
- ✅ 邀请奖励自动发放（10 USDT）
- ✅ 交易分红奖励（交易额 1%，最高 100 USDT）
- ✅ 新用户红包（首次交易 5 USDT）
- ✅ 抽奖功能（每邀请 5 人获得 1 次机会）
- ✅ 月度排行榜显示

### 3. 用户界面
- ✅ 主键盘添加"🎁 分享有礼"按钮
- ✅ 分享活动主页面
- ✅ 邀请好友页面（含推荐码和分享链接）
- ✅ 我的奖励记录页面
- ✅ 月度排行榜页面
- ✅ 抽奖页面

### 4. 自动化流程
- ✅ `/start` 命令自动处理推荐码（`/start?ref=CODE`）
- ✅ 交易完成时自动触发奖励发放
- ✅ 首次交易自动发放新用户红包

## 📋 活动规则

### 一级推荐奖励
- **邀请奖励**：成功邀请好友注册并使用机器人 → **10 USDT**
- **交易分红**：被邀请好友首次交易成功 → **交易额 1%**（最高 100 USDT/笔）
- **新用户红包**：被邀请的好友首次交易 → **5 USDT**

### 抽奖活动
- **参与条件**：每成功邀请 **5 位好友**（需完成首次交易）
- **奖品设置**：
  - 🏆 一等奖：500 USDT（10% 概率）
  - 🥈 二等奖：100 USDT（20% 概率）
  - 🥉 三等奖：50 USDT（30% 概率）
  - 🎁 幸运奖：10 USDT（40% 概率）

### 月度排行榜
- **统计周期**：每月 1 日 00:00 至月底 23:59
- **排名规则**：按成功邀请好友数量排名
- **奖励**：
  - 🥇 第 1 名：**999 USDT** + VIP3 等级
  - 🥈 第 2 名：**888 USDT** + VIP2 等级
  - 🥉 第 3 名：**777 USDT** + VIP1 等级
  - 🎖️ 第 4-10 名：**100 USDT**
- **发放时间**：次月 5 日前发放

## 🚀 部署步骤

### 1. 拉取最新代码
```bash
cd ~/wushizhifu/bot
git pull origin main
```

### 2. 清理缓存
```bash
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null
find . -type f -name "*.pyc" -delete 2>/dev/null
```

### 3. 重启服务
```bash
sudo systemctl restart wushizhifu-bot
```

### 4. 验证数据库表
数据库会自动创建新表，但可以验证：
```bash
sqlite3 ~/wushizhifu/bot/wushipay.db ".tables" | grep referral
```

应该看到：
- referral_codes
- referrals
- referral_rewards
- lottery_entries
- monthly_rankings

### 5. 查看日志
```bash
sudo journalctl -u wushizhifu-bot -n 50 --no-pager
```

## 🎯 功能测试

### 测试邀请流程
1. 用户 A 点击"🎁 分享有礼" → "📱 邀请好友"
2. 复制推荐码或分享链接
3. 用户 B 通过分享链接注册（`/start?ref=CODE`）
4. 用户 B 完成首次交易
5. 系统自动发放奖励：
   - 用户 A：10 USDT（邀请奖励）+ 交易额 1%（交易分红）
   - 用户 B：5 USDT（新用户红包）

### 测试抽奖功能
1. 邀请 5 位好友完成首次交易
2. 进入"🎲 抽奖"页面
3. 点击"开始抽奖"
4. 获得随机奖品

### 测试排行榜
1. 进入"🏆 排行榜"页面
2. 查看本月排名
3. 查看距离结算时间

## 📊 后续优化建议

### 短期优化（可选）
1. **月度排行榜自动更新**：添加定时任务更新排名
2. **奖励自动发放**：添加定时任务发放月度排行榜奖励
3. **防作弊机制**：检测异常邀请行为
4. **数据统计报表**：管理员查看分享活动数据

### 长期优化（可选）
1. **二级推荐**：好友的好友也能获得奖励
2. **里程碑奖励**：邀请达到 10/50/100 人额外奖励
3. **专属活动**：限时双倍奖励活动
4. **分享素材**：提供精美的分享海报和文案

## ⚠️ 注意事项

1. **奖励发放**：目前奖励记录状态为 `pending`，需要后续实现自动或手动发放机制
2. **月度排行榜**：目前只显示排名，月度奖励发放需要单独实现
3. **抽奖限制**：目前每月最多抽奖次数未限制，可以后续添加（建议每月最多 10 次）
4. **数据清理**：定期清理过期的推荐关系数据（建议保留 1 年）

## 📝 代码文件清单

### 新增文件
- `database/referral_repository.py` - 推荐系统数据库操作
- `handlers/referral_handlers.py` - 分享活动处理程序
- `分享活动系统设计方案.md` - 详细设计方案
- `分享活动系统部署说明.md` - 本文档

### 修改文件
- `database/models.py` - 添加推荐相关数据库表
- `keyboards/main_kb.py` - 添加"分享有礼"按钮
- `bot.py` - 注册 referral_router
- `handlers/user_handlers.py` - 处理 `/start` 命令的 ref 参数
- `services/transaction_service.py` - 交易完成时触发奖励发放

## 🎉 完成！

分享活动系统已完整实现，可以开始使用。用户点击"🎁 分享有礼"按钮即可参与活动，邀请好友获得丰厚奖励！

